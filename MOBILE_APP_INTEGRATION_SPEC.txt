# üì± MOBILE APP INTEGRATION SPECIFICATION
# ============================================================================
# Based on: Old mDaiBackend implementation analysis
# ============================================================================

## üîÑ COMPLETE FLOW (Hardware + Mobile)

### STEP 1: Hardware Registration (One-time)
```bash
# On RDK device
sudo /home/mercleDev/codebase/tools/register_device_to_ec2.sh

# Result:
- Device gets TEE-based device_id
- Public key uploaded to EC2
- Device ready for sessions
```

### STEP 2: Mobile App Session Creation
```
User opens mobile app ‚Üí wants to start face verification session

CURRENT PROBLEM: No endpoint for mobile to create sessions!
```

### STEP 3: Session Flow (What Should Happen)

#### Option A: Simplified Token-Based (Like Old System) ‚≠ê RECOMMENDED
```
1. Mobile app calls: POST /api/auth/mobile
   Body: {
     "user_id": "user123",
     "api_key": "mobile_app_key"
   }
   Response: {
     "token": "JWT_TOKEN_123",
     "session_id": "bson_id_xyz",
     "qr_payload": {...}
   }

2. Mobile generates QR with token + session_id

3. RDK scans QR ‚Üí extracts token + session_id

4. Both connect to WebSocket:
   - Mobile: wss://mdai.mercle.ai/ws/mobile?token=JWT_TOKEN_123
   - RDK:    wss://mdai.mercle.ai/ws/device?token=JWT_TOKEN_123

5. Server pairs them using token (like old system)

6. Messages flow:
   Mobile ‚Üí Server ‚Üí RDK: {"type": "to_device", "data": {"command": "start"}}
   RDK ‚Üí Server ‚Üí Mobile: {"type": "to_mobile", "data": {"progress": 50}}

7. RDK finishes tracking ‚Üí sends image + result

8. Server calls external API:
   POST https://newapi.mercle.ai/api/admin/hardware/next
   Headers: {"x-api-key": "mercle"}
   Body: {
     "platform_id": "PLT_jjbmYWeq3o1W",  // From mobile, NEVER sent to RDK
     "image_base64": "..."
   }

9. Server sends result to BOTH:
   - Mobile: {"type": "verification_result", "status": "success"}
   - RDK:    {"type": "verification_result", "status": "success"}
```

#### Option B: Challenge-Based (Current System Extension)
```
1. Mobile app calls: POST /api/session/create
   Headers: {"Authorization": "Bearer JWT_FROM_LOGIN"}
   Body: {
     "platform_id": "PLT_jjbmYWeq3o1W"
   }
   Response: {
     "session_id": "bson_id_xyz",
     "device_token": "ONE_TIME_JWT",  // For RDK to authenticate
     "mobile_token": "ANOTHER_JWT",   // For mobile to connect
     "qr_payload": {...}
   }

2. Mobile displays QR with session_id + device_token

3. RDK scans QR ‚Üí extracts session_id + device_token

4. RDK connects: wss://mdai.mercle.ai/ws/device?session_id=xyz&token=device_token

5. Mobile connects: wss://mdai.mercle.ai/ws/mobile?session_id=xyz&token=mobile_token

6. Server routes messages by session_id

7. Rest same as Option A
```

---

## üîç KEY DIFFERENCES: OLD vs NEW

| Feature | OLD System (FastAPI) | NEW System (aiohttp) | Status |
|---------|---------------------|---------------------|--------|
| **Hardware Auth** | JWT token from /auth | TrustZone + Challenge | ‚úÖ NEW |
| **Mobile Auth** | Same JWT as hardware | ??? | ‚ùå MISSING |
| **Pairing Method** | JWT JTI (single token) | ??? | ‚ùå MISSING |
| **Message Routing** | `to_hardware` / `to_app` | Direct session routing | ‚ö†Ô∏è PARTIAL |
| **Session Creation** | Hardware generates | ??? | ‚ùå MISSING |
| **QR Contents** | Token + URLs | Challenge + session_id | ‚úÖ DIFFERENT |
| **platform_id Flow** | Mobile ‚Üí HW ‚Üí Backend | ??? | ‚ùå MISSING |
| **Backend API Call** | From server after HW sends | Same intended | ‚ö†Ô∏è TODO |

---

## üö® CRITICAL MISSING COMPONENTS

### 1. Mobile Authentication Endpoint ‚ùå
```python
# Need to add to server.py:
@routes.post('/api/auth/mobile')
async def mobile_auth(request):
    """
    Authenticate mobile app and create session
    """
    data = await request.json()
    user_id = data.get('user_id')
    api_key = data.get('api_key')
    
    # Validate mobile API key
    if api_key != MOBILE_APP_API_KEY:
        raise HTTPException(401, "Invalid API key")
    
    # Generate session token
    session_id = str(ObjectId())
    token = generate_jwt(session_id)
    
    # Store session
    # ...
    
    return {
        "token": token,
        "session_id": session_id,
        "ws_url": "wss://mdai.mercle.ai/ws/mobile",
        "qr_payload": {
            "session_id": session_id,
            "token": token,
            "ws_device_url": "wss://mdai.mercle.ai/ws/device"
        }
    }
```

### 2. Mobile WebSocket Handler ‚ùå
```python
# Need to add to server.py:
@app.get('/ws/mobile')
async def ws_mobile(websocket: WebSocket, token: str = Query(...)):
    """
    WebSocket endpoint for mobile app connections
    """
    # Verify token
    session = verify_mobile_token(token)
    
    # Accept connection
    await websocket.accept()
    
    # Store in active connections with session_id
    mobile_connections[session.id] = websocket
    
    # Handle messages
    # ...
```

### 3. Session Pairing Manager ‚ùå
```python
class SessionPair:
    def __init__(self, session_id: str):
        self.session_id = session_id
        self.mobile_ws: Optional[WebSocket] = None
        self.device_ws: Optional[WebSocket] = None
        self.platform_id: str = None  # NEVER sent to device!
        self.created_at = datetime.now()
    
    async def route_message(self, from_side: str, message: dict):
        """Route message from one side to the other"""
        if from_side == 'mobile':
            # Strip platform_id before sending to device
            sanitized = {k: v for k, v in message.items() if k != 'platform_id'}
            if self.device_ws:
                await self.device_ws.send_json(sanitized)
        elif from_side == 'device':
            # Can send full message to mobile
            if self.mobile_ws:
                await self.mobile_ws.send_json(message)
```

### 4. Platform ID Privacy Protection ‚ùå
```python
# Currently: RDK might receive platform_id
# Should be: Server keeps platform_id, only uses for backend API

async def handle_device_result(session: SessionPair, result_data: dict):
    """
    Handle result from device without exposing platform_id to device
    """
    image = result_data.get('image_base64')
    consecutive_passes = result_data.get('consecutive_passes')
    
    # Server has platform_id from mobile connection
    platform_id = session.platform_id
    
    # Call backend API (device never sees platform_id)
    api_result = await call_backend_api(platform_id, image)
    
    # Send result to BOTH mobile and device
    await session.mobile_ws.send_json({
        'type': 'verification_result',
        'status': api_result['status'],
        'platform_id': platform_id  # Mobile sees it
    })
    
    await session.device_ws.send_json({
        'type': 'verification_result',
        'status': api_result['status']
        # NO platform_id for device!
    })
```

### 5. Backend API Integration ‚ùå
```python
# Need to implement the TODO at line 600
async def call_backend_api(platform_id: str, image_base64: str) -> dict:
    """
    Call external verification API
    """
    try:
        async with aiohttp.ClientSession() as session:
            async with session.post(
                "https://newapi.mercle.ai/api/admin/hardware/next",
                headers={"x-api-key": "mercle", "content-type": "application/json"},
                json={"platform_id": platform_id, "image_base64": image_base64},
                timeout=60
            ) as resp:
                return await resp.json()
    except Exception as e:
        logger.error(f"Backend API call failed: {e}")
        return {"status": "error", "message": str(e)}
```

---

## üìä IMPLEMENTATION PRIORITY

### üî¥ CRITICAL (Blocks Testing)
1. **Mobile Authentication Endpoint** - Can't create sessions without it
2. **Mobile WebSocket Handler** - Can't connect mobile app
3. **Session Pairing System** - Can't route messages between mobile & device

### üü° IMPORTANT (For Production)
4. **platform_id Privacy** - Security/privacy issue
5. **Backend API Integration** - Replace TODO placeholder

### üü¢ OPTIONAL (Enhancement)
6. **JWT Refresh** - Long sessions
7. **Mobile Login** - User authentication
8. **Device Management UI** - Admin dashboard

---

## üéØ RECOMMENDED APPROACH

### Use **Option A: Simplified Token-Based** (Like Old System)

**Why?**
- ‚úÖ Simpler mobile app integration
- ‚úÖ Single QR contains everything
- ‚úÖ Proven architecture (old system worked)
- ‚úÖ Easy pairing logic
- ‚úÖ Backwards compatible with old mobile app (if it exists)

**Implementation Steps:**
1. Add mobile auth endpoint (30 min)
2. Add mobile WebSocket handler (30 min)
3. Implement token-based pairing (1 hour)
4. Add message routing with platform_id privacy (30 min)
5. Integrate backend API call (30 min)

**Total Time**: ~3 hours

---

## üìù MOBILE APP QR FORMAT

### Old System (Working):
```json
{
  "token": "eyJhbGc...",  // JWT for both sides
  "ws_app_url": "wss://mdai.mercle.ai/ws/app",
  "ws_hardware_url": "wss://mdai.mercle.ai/ws/hardware",
  "server_host": "mdai.mercle.ai"
}
```

### New System (Proposed):
```json
{
  "session_id": "507f1f77bcf86cd799439011",  // BSON ID
  "token": "eyJhbGc...",  // JWT for pairing
  "ws_device_url": "wss://mdai.mercle.ai/ws/device",
  "ws_mobile_url": "wss://mdai.mercle.ai/ws/mobile",
  "type": "session"  // vs "wifi"
}
```

---

## üîê SECURITY CONSIDERATIONS

1. **WiFi QR** (Admin ‚Üí Device):
   - Device-specific RSA challenge
   - Short-lived (5 min)
   - Single-use
   - ‚úÖ Already implemented

2. **Session QR** (Mobile ‚Üí Device):
   - Session-specific JWT
   - Medium-lived (3 min like old system)
   - Single-use
   - ‚ùå NOT implemented

3. **platform_id Protection**:
   - Mobile sends to server ‚úÖ
   - Server stores in session ‚úÖ
   - Server uses for API call ‚úÖ
   - **Device NEVER sees it** ‚ùå Need to ensure

4. **WebSocket Authentication**:
   - Mobile: JWT from /api/auth/mobile
   - Device: Session token from QR scan
   - Both validated by server

---

## üß™ TESTING FLOW

### Complete End-to-End Test:

```bash
# Terminal 1: Server
cd ec2-server
python3 server.py

# Terminal 2: RDK Device
cd /home/mercleDev/codebase
./build/mdai_system

# Terminal 3: Mobile Simulator
curl -X POST https://mdai.mercle.ai/api/auth/mobile \
  -H "Content-Type: application/json" \
  -d '{"user_id": "test_user", "api_key": "MOBILE_APP_KEY", "platform_id": "PLT_test123"}'

# Expected response:
{
  "token": "eyJ...",
  "session_id": "507f...",
  "qr_payload": {...}
}

# Terminal 4: Show QR to camera
# (RDK scans QR)

# Both connect to WebSocket
# Messages flow mobile ‚Üî server ‚Üî device
# Server calls backend API with platform_id
# Both receive result
```

---

## ‚úÖ SUMMARY

**Current Status**: 85% complete for **device-only** testing

**To enable mobile app**: Need 3 critical components
1. Mobile auth endpoint
2. Mobile WebSocket handler  
3. Session pairing system

**Estimated time**: 3-4 hours

**Recommended**: Implement Option A (token-based pairing like old system)

**Next Steps**: 
1. Discuss which option you prefer (A or B)
2. Implement the 3 critical components
3. Test complete flow with mobile simulator
4. Deploy to EC2
5. Test with real mobile app

---

Would you like me to implement Option A now?


# ============================================================================
# Based on: Old mDaiBackend implementation analysis
# ============================================================================

## üîÑ COMPLETE FLOW (Hardware + Mobile)

### STEP 1: Hardware Registration (One-time)
```bash
# On RDK device
sudo /home/mercleDev/codebase/tools/register_device_to_ec2.sh

# Result:
- Device gets TEE-based device_id
- Public key uploaded to EC2
- Device ready for sessions
```

### STEP 2: Mobile App Session Creation
```
User opens mobile app ‚Üí wants to start face verification session

CURRENT PROBLEM: No endpoint for mobile to create sessions!
```

### STEP 3: Session Flow (What Should Happen)

#### Option A: Simplified Token-Based (Like Old System) ‚≠ê RECOMMENDED
```
1. Mobile app calls: POST /api/auth/mobile
   Body: {
     "user_id": "user123",
     "api_key": "mobile_app_key"
   }
   Response: {
     "token": "JWT_TOKEN_123",
     "session_id": "bson_id_xyz",
     "qr_payload": {...}
   }

2. Mobile generates QR with token + session_id

3. RDK scans QR ‚Üí extracts token + session_id

4. Both connect to WebSocket:
   - Mobile: wss://mdai.mercle.ai/ws/mobile?token=JWT_TOKEN_123
   - RDK:    wss://mdai.mercle.ai/ws/device?token=JWT_TOKEN_123

5. Server pairs them using token (like old system)

6. Messages flow:
   Mobile ‚Üí Server ‚Üí RDK: {"type": "to_device", "data": {"command": "start"}}
   RDK ‚Üí Server ‚Üí Mobile: {"type": "to_mobile", "data": {"progress": 50}}

7. RDK finishes tracking ‚Üí sends image + result

8. Server calls external API:
   POST https://newapi.mercle.ai/api/admin/hardware/next
   Headers: {"x-api-key": "mercle"}
   Body: {
     "platform_id": "PLT_jjbmYWeq3o1W",  // From mobile, NEVER sent to RDK
     "image_base64": "..."
   }

9. Server sends result to BOTH:
   - Mobile: {"type": "verification_result", "status": "success"}
   - RDK:    {"type": "verification_result", "status": "success"}
```

#### Option B: Challenge-Based (Current System Extension)
```
1. Mobile app calls: POST /api/session/create
   Headers: {"Authorization": "Bearer JWT_FROM_LOGIN"}
   Body: {
     "platform_id": "PLT_jjbmYWeq3o1W"
   }
   Response: {
     "session_id": "bson_id_xyz",
     "device_token": "ONE_TIME_JWT",  // For RDK to authenticate
     "mobile_token": "ANOTHER_JWT",   // For mobile to connect
     "qr_payload": {...}
   }

2. Mobile displays QR with session_id + device_token

3. RDK scans QR ‚Üí extracts session_id + device_token

4. RDK connects: wss://mdai.mercle.ai/ws/device?session_id=xyz&token=device_token

5. Mobile connects: wss://mdai.mercle.ai/ws/mobile?session_id=xyz&token=mobile_token

6. Server routes messages by session_id

7. Rest same as Option A
```

---

## üîç KEY DIFFERENCES: OLD vs NEW

| Feature | OLD System (FastAPI) | NEW System (aiohttp) | Status |
|---------|---------------------|---------------------|--------|
| **Hardware Auth** | JWT token from /auth | TrustZone + Challenge | ‚úÖ NEW |
| **Mobile Auth** | Same JWT as hardware | ??? | ‚ùå MISSING |
| **Pairing Method** | JWT JTI (single token) | ??? | ‚ùå MISSING |
| **Message Routing** | `to_hardware` / `to_app` | Direct session routing | ‚ö†Ô∏è PARTIAL |
| **Session Creation** | Hardware generates | ??? | ‚ùå MISSING |
| **QR Contents** | Token + URLs | Challenge + session_id | ‚úÖ DIFFERENT |
| **platform_id Flow** | Mobile ‚Üí HW ‚Üí Backend | ??? | ‚ùå MISSING |
| **Backend API Call** | From server after HW sends | Same intended | ‚ö†Ô∏è TODO |

---

## üö® CRITICAL MISSING COMPONENTS

### 1. Mobile Authentication Endpoint ‚ùå
```python
# Need to add to server.py:
@routes.post('/api/auth/mobile')
async def mobile_auth(request):
    """
    Authenticate mobile app and create session
    """
    data = await request.json()
    user_id = data.get('user_id')
    api_key = data.get('api_key')
    
    # Validate mobile API key
    if api_key != MOBILE_APP_API_KEY:
        raise HTTPException(401, "Invalid API key")
    
    # Generate session token
    session_id = str(ObjectId())
    token = generate_jwt(session_id)
    
    # Store session
    # ...
    
    return {
        "token": token,
        "session_id": session_id,
        "ws_url": "wss://mdai.mercle.ai/ws/mobile",
        "qr_payload": {
            "session_id": session_id,
            "token": token,
            "ws_device_url": "wss://mdai.mercle.ai/ws/device"
        }
    }
```

### 2. Mobile WebSocket Handler ‚ùå
```python
# Need to add to server.py:
@app.get('/ws/mobile')
async def ws_mobile(websocket: WebSocket, token: str = Query(...)):
    """
    WebSocket endpoint for mobile app connections
    """
    # Verify token
    session = verify_mobile_token(token)
    
    # Accept connection
    await websocket.accept()
    
    # Store in active connections with session_id
    mobile_connections[session.id] = websocket
    
    # Handle messages
    # ...
```

### 3. Session Pairing Manager ‚ùå
```python
class SessionPair:
    def __init__(self, session_id: str):
        self.session_id = session_id
        self.mobile_ws: Optional[WebSocket] = None
        self.device_ws: Optional[WebSocket] = None
        self.platform_id: str = None  # NEVER sent to device!
        self.created_at = datetime.now()
    
    async def route_message(self, from_side: str, message: dict):
        """Route message from one side to the other"""
        if from_side == 'mobile':
            # Strip platform_id before sending to device
            sanitized = {k: v for k, v in message.items() if k != 'platform_id'}
            if self.device_ws:
                await self.device_ws.send_json(sanitized)
        elif from_side == 'device':
            # Can send full message to mobile
            if self.mobile_ws:
                await self.mobile_ws.send_json(message)
```

### 4. Platform ID Privacy Protection ‚ùå
```python
# Currently: RDK might receive platform_id
# Should be: Server keeps platform_id, only uses for backend API

async def handle_device_result(session: SessionPair, result_data: dict):
    """
    Handle result from device without exposing platform_id to device
    """
    image = result_data.get('image_base64')
    consecutive_passes = result_data.get('consecutive_passes')
    
    # Server has platform_id from mobile connection
    platform_id = session.platform_id
    
    # Call backend API (device never sees platform_id)
    api_result = await call_backend_api(platform_id, image)
    
    # Send result to BOTH mobile and device
    await session.mobile_ws.send_json({
        'type': 'verification_result',
        'status': api_result['status'],
        'platform_id': platform_id  # Mobile sees it
    })
    
    await session.device_ws.send_json({
        'type': 'verification_result',
        'status': api_result['status']
        # NO platform_id for device!
    })
```

### 5. Backend API Integration ‚ùå
```python
# Need to implement the TODO at line 600
async def call_backend_api(platform_id: str, image_base64: str) -> dict:
    """
    Call external verification API
    """
    try:
        async with aiohttp.ClientSession() as session:
            async with session.post(
                "https://newapi.mercle.ai/api/admin/hardware/next",
                headers={"x-api-key": "mercle", "content-type": "application/json"},
                json={"platform_id": platform_id, "image_base64": image_base64},
                timeout=60
            ) as resp:
                return await resp.json()
    except Exception as e:
        logger.error(f"Backend API call failed: {e}")
        return {"status": "error", "message": str(e)}
```

---

## üìä IMPLEMENTATION PRIORITY

### üî¥ CRITICAL (Blocks Testing)
1. **Mobile Authentication Endpoint** - Can't create sessions without it
2. **Mobile WebSocket Handler** - Can't connect mobile app
3. **Session Pairing System** - Can't route messages between mobile & device

### üü° IMPORTANT (For Production)
4. **platform_id Privacy** - Security/privacy issue
5. **Backend API Integration** - Replace TODO placeholder

### üü¢ OPTIONAL (Enhancement)
6. **JWT Refresh** - Long sessions
7. **Mobile Login** - User authentication
8. **Device Management UI** - Admin dashboard

---

## üéØ RECOMMENDED APPROACH

### Use **Option A: Simplified Token-Based** (Like Old System)

**Why?**
- ‚úÖ Simpler mobile app integration
- ‚úÖ Single QR contains everything
- ‚úÖ Proven architecture (old system worked)
- ‚úÖ Easy pairing logic
- ‚úÖ Backwards compatible with old mobile app (if it exists)

**Implementation Steps:**
1. Add mobile auth endpoint (30 min)
2. Add mobile WebSocket handler (30 min)
3. Implement token-based pairing (1 hour)
4. Add message routing with platform_id privacy (30 min)
5. Integrate backend API call (30 min)

**Total Time**: ~3 hours

---

## üìù MOBILE APP QR FORMAT

### Old System (Working):
```json
{
  "token": "eyJhbGc...",  // JWT for both sides
  "ws_app_url": "wss://mdai.mercle.ai/ws/app",
  "ws_hardware_url": "wss://mdai.mercle.ai/ws/hardware",
  "server_host": "mdai.mercle.ai"
}
```

### New System (Proposed):
```json
{
  "session_id": "507f1f77bcf86cd799439011",  // BSON ID
  "token": "eyJhbGc...",  // JWT for pairing
  "ws_device_url": "wss://mdai.mercle.ai/ws/device",
  "ws_mobile_url": "wss://mdai.mercle.ai/ws/mobile",
  "type": "session"  // vs "wifi"
}
```

---

## üîê SECURITY CONSIDERATIONS

1. **WiFi QR** (Admin ‚Üí Device):
   - Device-specific RSA challenge
   - Short-lived (5 min)
   - Single-use
   - ‚úÖ Already implemented

2. **Session QR** (Mobile ‚Üí Device):
   - Session-specific JWT
   - Medium-lived (3 min like old system)
   - Single-use
   - ‚ùå NOT implemented

3. **platform_id Protection**:
   - Mobile sends to server ‚úÖ
   - Server stores in session ‚úÖ
   - Server uses for API call ‚úÖ
   - **Device NEVER sees it** ‚ùå Need to ensure

4. **WebSocket Authentication**:
   - Mobile: JWT from /api/auth/mobile
   - Device: Session token from QR scan
   - Both validated by server

---

## üß™ TESTING FLOW

### Complete End-to-End Test:

```bash
# Terminal 1: Server
cd ec2-server
python3 server.py

# Terminal 2: RDK Device
cd /home/mercleDev/codebase
./build/mdai_system

# Terminal 3: Mobile Simulator
curl -X POST https://mdai.mercle.ai/api/auth/mobile \
  -H "Content-Type: application/json" \
  -d '{"user_id": "test_user", "api_key": "MOBILE_APP_KEY", "platform_id": "PLT_test123"}'

# Expected response:
{
  "token": "eyJ...",
  "session_id": "507f...",
  "qr_payload": {...}
}

# Terminal 4: Show QR to camera
# (RDK scans QR)

# Both connect to WebSocket
# Messages flow mobile ‚Üî server ‚Üî device
# Server calls backend API with platform_id
# Both receive result
```

---

## ‚úÖ SUMMARY

**Current Status**: 85% complete for **device-only** testing

**To enable mobile app**: Need 3 critical components
1. Mobile auth endpoint
2. Mobile WebSocket handler  
3. Session pairing system

**Estimated time**: 3-4 hours

**Recommended**: Implement Option A (token-based pairing like old system)

**Next Steps**: 
1. Discuss which option you prefer (A or B)
2. Implement the 3 critical components
3. Test complete flow with mobile simulator
4. Deploy to EC2
5. Test with real mobile app

---

Would you like me to implement Option A now?






