# ğŸ”„ OLD vs NEW SYSTEM - SIDE-BY-SIDE COMPARISON

## ARCHITECTURE COMPARISON

### OLD SYSTEM (mDaiBackend - FastAPI)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   HARDWARE  â”‚â”€â”€â”
â”‚   (RDK X5)  â”‚  â”‚  1. Hardware calls /auth â†’ JWT
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  2. Hardware generates QR with JWT
                 â”‚  3. Mobile scans QR
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  
â”‚  MOBILE APP â”‚â”€â”€â”¤  Both connect with SAME token:
â”‚  (Flutter)  â”‚  â”‚  - ws://server/ws/hardware?token=JWT
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  - ws://server/ws/app?token=JWT
                 â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚   FastAPI Server  â”‚
       â”‚  Pairs by JWT.JTI â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
         Backend API Call
    https://newapi.mercle.ai
```

**Data Flow:**
1. Mobile â†’ Server: `{"type": "to_hardware", "data": {"platform_id": "PLT_xxx"}}`
2. Server â†’ Hardware: `{"type": "from_app", "data": {"platform_id": "PLT_xxx"}}`
3. Hardware processes, sends: `{"type": "to_backend", "data": {"platform_id": "PLT_xxx", "image": "..."}}`
4. Server calls API with platform_id + image
5. Server â†’ Both: `{"type": "backend_response", ...}`

---

### NEW SYSTEM (MDAI - aiohttp)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   HARDWARE  â”‚â”€â”€â”
â”‚   (RDK X5)  â”‚  â”‚  1. Admin generates WiFi QR (RSA challenge)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  2. Device scans, validates, connects
                 â”‚  3. Device gets session somehow??? âŒ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  
â”‚  MOBILE APP â”‚â”€â”€â”¤  ??? How does mobile connect? âŒ
â”‚  (Flutter)  â”‚  â”‚  ??? Where does session come from? âŒ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                 â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚   aiohttp Server  â”‚
       â”‚  Sessions in DB   â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
       Backend API (TODO)
```

**Current Implementation:**
- âœ… Device registration (TrustZone + public key)
- âœ… WiFi provisioning (challenge-response QR)
- âœ… Device WebSocket (partial)
- âŒ Mobile authentication
- âŒ Session creation
- âŒ Message routing
- âŒ platform_id handling

---

## MESSAGE FLOW COMPARISON

### OLD SYSTEM - Complete Flow âœ…

```
STEP 1: Authentication
Mobile: N/A (uses same token as hardware)
Hardware: POST /auth â†’ {"token": "eyJ..."}

STEP 2: QR Generation
Hardware generates QR:
{
  "token": "eyJ...",
  "ws_app_url": "wss://host/ws/app",
  "ws_hardware_url": "wss://host/ws/hardware"
}

STEP 3: Both Connect
Hardware: ws://host/ws/hardware?token=eyJ...
  â†’ Server: {"type": "joined", "role": "hardware"}
Mobile: ws://host/ws/app?token=eyJ...
  â†’ Server: {"type": "joined", "role": "app"}

Server pairs them via token.jti

STEP 4: Handshake
Mobile â†’ Server: {"type": "to_hardware", "data": {"message": "hello"}}
Server â†’ Hardware: {"type": "from_app", "data": {"message": "hello"}}

Hardware â†’ Server: {"type": "to_app", "data": {"message": "hello"}}
Server â†’ Mobile: {"type": "from_hardware", "data": {"message": "hello"}}

STEP 5: Platform ID
Mobile â†’ Server: {"type": "to_hardware", "data": {"platform_id": "PLT_jjbmYWeq3o1W"}}
Server â†’ Hardware: {"type": "from_app", "data": {"platform_id": "PLT_jjbmYWeq3o1W"}}
                                                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
                                                  âš ï¸ Platform ID exposed to hardware!

STEP 6: Image Submission
Hardware â†’ Server: {"type": "to_backend", "data": {"platform_id": "PLT_...", "image_base64": "..."}}
Server calls: POST https://newapi.mercle.ai/api/admin/hardware/next
  Headers: {"x-api-key": "mercle"}
  Body: {"platform_id": "PLT_...", "image_base64": "..."}

STEP 7: Result
Backend â†’ Server: {"status": "success", ...}
Server â†’ Hardware: {"type": "backend_response", "status_code": 200, "data": {...}}
Server â†’ Mobile: {"type": "backend_response", "status_code": 200, "data": {...}}
```

---

### NEW SYSTEM - Current Implementation âš ï¸

```
STEP 1: Device Registration âœ…
Device: POST /api/register-device
  Body: {"device_id": "TEE-...", "public_key": "-----BEGIN..."}
  Response: {"success": true}

STEP 2: WiFi Provisioning âœ…
Admin: POST /api/generate-challenge
  Body: {"device_id": "TEE-...", "wifi_ssid": "...", "wifi_password": "..."}
  Response: {"qr_payload": {"bson_id": "...", "challenge": "encrypted..."}}

Device scans QR â†’ decrypts challenge â†’ validates:
Device: POST /api/validate-challenge
  Body: {"bson_id": "...", "challenge_response": "..."}
  Response: {"success": true, "wifi_credentials": {...}}

Device connects to WiFi âœ…

STEP 3: Session Creation âŒ MISSING
Mobile: ??? 
  â†’ How does mobile create session?
  â†’ How does mobile get QR data?
  â†’ What does the session QR contain?

STEP 4: Both Connect âŒ MISSING
Mobile: ???
  â†’ wss://mdai.mercle.ai/ws/???
  â†’ What token/auth?

Device: wss://mdai.mercle.ai/ws/?
  â†’ Connects after scanning session QR
  â†’ Sends: {"type": "auth", "session_id": "...", "device_id": "..."}

STEP 5: Message Routing âŒ MISSING
Mobile â†’ Device: ???
Device â†’ Mobile: ???
  â†’ No routing logic implemented!

STEP 6: Platform ID âŒ CRITICAL ISSUE
Current code (server.py line 594):
  platform_id = data.get('platform_id')  # From device message!
  
This means device RECEIVES platform_id from somewhere, which is wrong!

Should be:
  - Mobile sends platform_id ONLY to server
  - Server stores in session
  - Device NEVER sees platform_id
  - Server uses stored platform_id for API call

STEP 7: Backend API âš ï¸ TODO
Current code (server.py line 600):
  # TODO: Call external API with platform_id and image
  # For now, simulate success after validation

Needs implementation!
```

---

## KEY INSIGHTS FROM OLD SYSTEM

### 1. **Simple Token-Based Pairing** âœ…
- Hardware generates ONE token
- Both hardware and mobile use SAME token
- Server pairs them by `token.jti` (JWT ID)
- No complex session management needed

**Advantage**: Simple, works well!

### 2. **QR Contains Everything** âœ…
```json
{
  "token": "eyJ...",
  "ws_app_url": "wss://mdai.mercle.ai/ws/app",
  "ws_hardware_url": "wss://mdai.mercle.ai/ws/hardware",
  "server_host": "mdai.mercle.ai"
}
```
Mobile app just needs to:
1. Scan QR
2. Extract token + ws_app_url
3. Connect to WebSocket with token
4. Done!

### 3. **Message Types Are Clear** âœ…
- `to_hardware` / `to_app` - explicit routing
- `from_hardware` / `from_app` - clear source
- `backend_response` - API result to both
- `ping` / `pong` - keepalive
- `status` - connection status
- `error` - error messages

### 4. **Platform ID Flow** âš ï¸ (Has Privacy Issue)
Old system: Mobile â†’ Server â†’ **Hardware** â†’ Server â†’ API
                                 ^^^^^^^^
                                 Hardware sees platform_id!

Should be: Mobile â†’ Server â†’ API (hardware never sees it)

### 5. **Hard Timeout** âœ…
JWT expires after 3 minutes â†’ both connections close
Clean, predictable lifecycle

---

## PROPOSED NEW SYSTEM (Best of Both)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MOBILE APP â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 1. POST /api/auth/mobile
       â”‚    Body: {"user_id": "...", "platform_id": "PLT_xxx"}
       â”‚    Response: {"token": "JWT", "session_id": "bson_id", "qr_payload": {...}}
       â”‚
       â”‚ 2. Display QR:
       â”‚    {
       â”‚      "session_id": "bson_id",
       â”‚      "token": "JWT",
       â”‚      "ws_device_url": "wss://mdai.mercle.ai/ws/device",
       â”‚      "type": "session"
       â”‚    }
       â”‚
       â”‚ 3. Connect WebSocket:
       â”‚    wss://mdai.mercle.ai/ws/mobile?token=JWT
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     aiohttp Server (EC2)            â”‚
â”‚                                     â”‚
â”‚  Session Storage:                   â”‚
â”‚  {                                  â”‚
â”‚    "session_id": "bson_id",         â”‚
â”‚    "token": "JWT",                  â”‚
â”‚    "platform_id": "PLT_xxx", â—„â”€â”€â”€â”€â”€â”€â”¼â”€â”€ Stored, never sent to device
â”‚    "mobile_ws": <connection>,       â”‚
â”‚    "device_ws": None,               â”‚
â”‚    "created_at": "...",             â”‚
â”‚    "expires_at": "..."              â”‚
â”‚  }                                  â”‚
â”‚                                     â”‚
â”‚  Message Routing:                   â”‚
â”‚  â€¢ Strip platform_id before â†’ deviceâ”‚
â”‚  â€¢ Keep platform_id for API calls   â”‚
â”‚  â€¢ Full messages to â†’ mobile        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â”‚ 4. Device scans QR
                  â”‚    Extracts: session_id + token
                  â”‚
                  â”‚ 5. Device connects:
                  â”‚    wss://mdai.mercle.ai/ws/device?token=JWT
                  â”‚    Send: {"type": "auth", "session_id": "bson_id"}
                  â”‚
                  â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚   HARDWARE  â”‚
          â”‚   (RDK X5)  â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â”‚ 6. Face tracking complete
                  â”‚    Send: {"type": "submit_result", "image": "...", "passes": 5}
                  â”‚         (NO platform_id!)
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Server calls Backend API:       â”‚
â”‚  POST https://newapi.mercle.ai/...  â”‚
â”‚  Body: {                            â”‚
â”‚    "platform_id": "PLT_xxx", â—„â”€â”€â”€â”€â”€â”€â”¼â”€â”€ From stored session
â”‚    "image_base64": "..."            â”‚
â”‚  }                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â”‚ 7. Send result to BOTH:
                  â”‚
                  â”œâ”€â†’ Mobile: {"type": "result", "status": "success", "platform_id": "PLT_xxx"}
                  â”‚
                  â””â”€â†’ Device: {"type": "result", "status": "success"}
                              (NO platform_id!)
```

**Benefits:**
- âœ… Simple token-based pairing (like old system)
- âœ… Platform ID privacy protected (NEW)
- âœ… TrustZone hardware identity (NEW)
- âœ… Clear separation of concerns
- âœ… Mobile-initiated sessions
- âœ… Backend API properly integrated

---

## ğŸ“‹ WHAT TO IMPLEMENT

### To match OLD system's functionality + NEW security:

1. **Mobile Auth Endpoint** (from old system)
2. **Mobile WebSocket Handler** (from old system)
3. **Token-based Pairing** (from old system)
4. **Message Routing** (from old system + NEW privacy)
5. **Backend API Integration** (complete the TODO)
6. **Session Management** (NEW - already have DB tables)

**Estimated Time**: 3-4 hours
**Complexity**: Medium (combining two proven approaches)

---

## ğŸ¯ RECOMMENDATION

**Implement: Hybrid Approach**
- Use old system's simple token pairing âœ…
- Keep new system's TrustZone security âœ…
- Add platform_id privacy protection âœ…
- Complete backend API integration âœ…

This gives you:
- Best security (TrustZone + privacy)
- Best usability (simple QR + pairing)
- Best compatibility (works like old app expected)
- Best maintainability (clear, proven patterns)

**Ready to implement?**



## ARCHITECTURE COMPARISON

### OLD SYSTEM (mDaiBackend - FastAPI)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   HARDWARE  â”‚â”€â”€â”
â”‚   (RDK X5)  â”‚  â”‚  1. Hardware calls /auth â†’ JWT
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  2. Hardware generates QR with JWT
                 â”‚  3. Mobile scans QR
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  
â”‚  MOBILE APP â”‚â”€â”€â”¤  Both connect with SAME token:
â”‚  (Flutter)  â”‚  â”‚  - ws://server/ws/hardware?token=JWT
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  - ws://server/ws/app?token=JWT
                 â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚   FastAPI Server  â”‚
       â”‚  Pairs by JWT.JTI â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
         Backend API Call
    https://newapi.mercle.ai
```

**Data Flow:**
1. Mobile â†’ Server: `{"type": "to_hardware", "data": {"platform_id": "PLT_xxx"}}`
2. Server â†’ Hardware: `{"type": "from_app", "data": {"platform_id": "PLT_xxx"}}`
3. Hardware processes, sends: `{"type": "to_backend", "data": {"platform_id": "PLT_xxx", "image": "..."}}`
4. Server calls API with platform_id + image
5. Server â†’ Both: `{"type": "backend_response", ...}`

---

### NEW SYSTEM (MDAI - aiohttp)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   HARDWARE  â”‚â”€â”€â”
â”‚   (RDK X5)  â”‚  â”‚  1. Admin generates WiFi QR (RSA challenge)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  2. Device scans, validates, connects
                 â”‚  3. Device gets session somehow??? âŒ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  
â”‚  MOBILE APP â”‚â”€â”€â”¤  ??? How does mobile connect? âŒ
â”‚  (Flutter)  â”‚  â”‚  ??? Where does session come from? âŒ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                 â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚   aiohttp Server  â”‚
       â”‚  Sessions in DB   â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
       Backend API (TODO)
```

**Current Implementation:**
- âœ… Device registration (TrustZone + public key)
- âœ… WiFi provisioning (challenge-response QR)
- âœ… Device WebSocket (partial)
- âŒ Mobile authentication
- âŒ Session creation
- âŒ Message routing
- âŒ platform_id handling

---

## MESSAGE FLOW COMPARISON

### OLD SYSTEM - Complete Flow âœ…

```
STEP 1: Authentication
Mobile: N/A (uses same token as hardware)
Hardware: POST /auth â†’ {"token": "eyJ..."}

STEP 2: QR Generation
Hardware generates QR:
{
  "token": "eyJ...",
  "ws_app_url": "wss://host/ws/app",
  "ws_hardware_url": "wss://host/ws/hardware"
}

STEP 3: Both Connect
Hardware: ws://host/ws/hardware?token=eyJ...
  â†’ Server: {"type": "joined", "role": "hardware"}
Mobile: ws://host/ws/app?token=eyJ...
  â†’ Server: {"type": "joined", "role": "app"}

Server pairs them via token.jti

STEP 4: Handshake
Mobile â†’ Server: {"type": "to_hardware", "data": {"message": "hello"}}
Server â†’ Hardware: {"type": "from_app", "data": {"message": "hello"}}

Hardware â†’ Server: {"type": "to_app", "data": {"message": "hello"}}
Server â†’ Mobile: {"type": "from_hardware", "data": {"message": "hello"}}

STEP 5: Platform ID
Mobile â†’ Server: {"type": "to_hardware", "data": {"platform_id": "PLT_jjbmYWeq3o1W"}}
Server â†’ Hardware: {"type": "from_app", "data": {"platform_id": "PLT_jjbmYWeq3o1W"}}
                                                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
                                                  âš ï¸ Platform ID exposed to hardware!

STEP 6: Image Submission
Hardware â†’ Server: {"type": "to_backend", "data": {"platform_id": "PLT_...", "image_base64": "..."}}
Server calls: POST https://newapi.mercle.ai/api/admin/hardware/next
  Headers: {"x-api-key": "mercle"}
  Body: {"platform_id": "PLT_...", "image_base64": "..."}

STEP 7: Result
Backend â†’ Server: {"status": "success", ...}
Server â†’ Hardware: {"type": "backend_response", "status_code": 200, "data": {...}}
Server â†’ Mobile: {"type": "backend_response", "status_code": 200, "data": {...}}
```

---

### NEW SYSTEM - Current Implementation âš ï¸

```
STEP 1: Device Registration âœ…
Device: POST /api/register-device
  Body: {"device_id": "TEE-...", "public_key": "-----BEGIN..."}
  Response: {"success": true}

STEP 2: WiFi Provisioning âœ…
Admin: POST /api/generate-challenge
  Body: {"device_id": "TEE-...", "wifi_ssid": "...", "wifi_password": "..."}
  Response: {"qr_payload": {"bson_id": "...", "challenge": "encrypted..."}}

Device scans QR â†’ decrypts challenge â†’ validates:
Device: POST /api/validate-challenge
  Body: {"bson_id": "...", "challenge_response": "..."}
  Response: {"success": true, "wifi_credentials": {...}}

Device connects to WiFi âœ…

STEP 3: Session Creation âŒ MISSING
Mobile: ??? 
  â†’ How does mobile create session?
  â†’ How does mobile get QR data?
  â†’ What does the session QR contain?

STEP 4: Both Connect âŒ MISSING
Mobile: ???
  â†’ wss://mdai.mercle.ai/ws/???
  â†’ What token/auth?

Device: wss://mdai.mercle.ai/ws/?
  â†’ Connects after scanning session QR
  â†’ Sends: {"type": "auth", "session_id": "...", "device_id": "..."}

STEP 5: Message Routing âŒ MISSING
Mobile â†’ Device: ???
Device â†’ Mobile: ???
  â†’ No routing logic implemented!

STEP 6: Platform ID âŒ CRITICAL ISSUE
Current code (server.py line 594):
  platform_id = data.get('platform_id')  # From device message!
  
This means device RECEIVES platform_id from somewhere, which is wrong!

Should be:
  - Mobile sends platform_id ONLY to server
  - Server stores in session
  - Device NEVER sees platform_id
  - Server uses stored platform_id for API call

STEP 7: Backend API âš ï¸ TODO
Current code (server.py line 600):
  # TODO: Call external API with platform_id and image
  # For now, simulate success after validation

Needs implementation!
```

---

## KEY INSIGHTS FROM OLD SYSTEM

### 1. **Simple Token-Based Pairing** âœ…
- Hardware generates ONE token
- Both hardware and mobile use SAME token
- Server pairs them by `token.jti` (JWT ID)
- No complex session management needed

**Advantage**: Simple, works well!

### 2. **QR Contains Everything** âœ…
```json
{
  "token": "eyJ...",
  "ws_app_url": "wss://mdai.mercle.ai/ws/app",
  "ws_hardware_url": "wss://mdai.mercle.ai/ws/hardware",
  "server_host": "mdai.mercle.ai"
}
```
Mobile app just needs to:
1. Scan QR
2. Extract token + ws_app_url
3. Connect to WebSocket with token
4. Done!

### 3. **Message Types Are Clear** âœ…
- `to_hardware` / `to_app` - explicit routing
- `from_hardware` / `from_app` - clear source
- `backend_response` - API result to both
- `ping` / `pong` - keepalive
- `status` - connection status
- `error` - error messages

### 4. **Platform ID Flow** âš ï¸ (Has Privacy Issue)
Old system: Mobile â†’ Server â†’ **Hardware** â†’ Server â†’ API
                                 ^^^^^^^^
                                 Hardware sees platform_id!

Should be: Mobile â†’ Server â†’ API (hardware never sees it)

### 5. **Hard Timeout** âœ…
JWT expires after 3 minutes â†’ both connections close
Clean, predictable lifecycle

---

## PROPOSED NEW SYSTEM (Best of Both)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MOBILE APP â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 1. POST /api/auth/mobile
       â”‚    Body: {"user_id": "...", "platform_id": "PLT_xxx"}
       â”‚    Response: {"token": "JWT", "session_id": "bson_id", "qr_payload": {...}}
       â”‚
       â”‚ 2. Display QR:
       â”‚    {
       â”‚      "session_id": "bson_id",
       â”‚      "token": "JWT",
       â”‚      "ws_device_url": "wss://mdai.mercle.ai/ws/device",
       â”‚      "type": "session"
       â”‚    }
       â”‚
       â”‚ 3. Connect WebSocket:
       â”‚    wss://mdai.mercle.ai/ws/mobile?token=JWT
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     aiohttp Server (EC2)            â”‚
â”‚                                     â”‚
â”‚  Session Storage:                   â”‚
â”‚  {                                  â”‚
â”‚    "session_id": "bson_id",         â”‚
â”‚    "token": "JWT",                  â”‚
â”‚    "platform_id": "PLT_xxx", â—„â”€â”€â”€â”€â”€â”€â”¼â”€â”€ Stored, never sent to device
â”‚    "mobile_ws": <connection>,       â”‚
â”‚    "device_ws": None,               â”‚
â”‚    "created_at": "...",             â”‚
â”‚    "expires_at": "..."              â”‚
â”‚  }                                  â”‚
â”‚                                     â”‚
â”‚  Message Routing:                   â”‚
â”‚  â€¢ Strip platform_id before â†’ deviceâ”‚
â”‚  â€¢ Keep platform_id for API calls   â”‚
â”‚  â€¢ Full messages to â†’ mobile        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â”‚ 4. Device scans QR
                  â”‚    Extracts: session_id + token
                  â”‚
                  â”‚ 5. Device connects:
                  â”‚    wss://mdai.mercle.ai/ws/device?token=JWT
                  â”‚    Send: {"type": "auth", "session_id": "bson_id"}
                  â”‚
                  â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚   HARDWARE  â”‚
          â”‚   (RDK X5)  â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â”‚ 6. Face tracking complete
                  â”‚    Send: {"type": "submit_result", "image": "...", "passes": 5}
                  â”‚         (NO platform_id!)
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Server calls Backend API:       â”‚
â”‚  POST https://newapi.mercle.ai/...  â”‚
â”‚  Body: {                            â”‚
â”‚    "platform_id": "PLT_xxx", â—„â”€â”€â”€â”€â”€â”€â”¼â”€â”€ From stored session
â”‚    "image_base64": "..."            â”‚
â”‚  }                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â”‚ 7. Send result to BOTH:
                  â”‚
                  â”œâ”€â†’ Mobile: {"type": "result", "status": "success", "platform_id": "PLT_xxx"}
                  â”‚
                  â””â”€â†’ Device: {"type": "result", "status": "success"}
                              (NO platform_id!)
```

**Benefits:**
- âœ… Simple token-based pairing (like old system)
- âœ… Platform ID privacy protected (NEW)
- âœ… TrustZone hardware identity (NEW)
- âœ… Clear separation of concerns
- âœ… Mobile-initiated sessions
- âœ… Backend API properly integrated

---

## ğŸ“‹ WHAT TO IMPLEMENT

### To match OLD system's functionality + NEW security:

1. **Mobile Auth Endpoint** (from old system)
2. **Mobile WebSocket Handler** (from old system)
3. **Token-based Pairing** (from old system)
4. **Message Routing** (from old system + NEW privacy)
5. **Backend API Integration** (complete the TODO)
6. **Session Management** (NEW - already have DB tables)

**Estimated Time**: 3-4 hours
**Complexity**: Medium (combining two proven approaches)

---

## ğŸ¯ RECOMMENDATION

**Implement: Hybrid Approach**
- Use old system's simple token pairing âœ…
- Keep new system's TrustZone security âœ…
- Add platform_id privacy protection âœ…
- Complete backend API integration âœ…

This gives you:
- Best security (TrustZone + privacy)
- Best usability (simple QR + pairing)
- Best compatibility (works like old app expected)
- Best maintainability (clear, proven patterns)

**Ready to implement?**






